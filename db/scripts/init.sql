CREATE TYPE permission_level_enum AS ENUM (
    'admin',
    'user'
);

CREATE TYPE visibility_enum AS ENUM (
    'public',
    'followers',
    'private'
);

CREATE TABLE users (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    first_name TEXT,
    last_name TEXT,
    bio TEXT,
    email TEXT UNIQUE,
    pass TEXT,
    date_created TIMESTAMP DEFAULT NOW(),
    permissions permission_level_enum NOT NULL DEFAULT 'user'
);

CREATE TABLE follows (
    follower BIGINT REFERENCES users,
    followed BIGINT REFERENCES users
);

CREATE TABLE posts (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    author BIGINT REFERENCES users ON DELETE CASCADE,
    title TEXT NOT NULL,
    content TEXT NOT NULL,
    content_image TEXT ARRAY,
    content_video TEXT ARRAY,
    content_document TEXT ARRAY,
    -- rate INTEGER NOT NULL DEFAULT 1 CONSTRAINT valid_rate CHECK (price >= 1 AND price <= 10),
    visibility visibility_enum NOT NULL DEFAULT 'public',
    likes BIGINT DEFAULT 0,
    date_created TIMESTAMP DEFAULT NOW(),
    date_updated TIMESTAMP
);

CREATE TABLE comments (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    author BIGINT REFERENCES users ON DELETE CASCADE,
    post BIGINT REFERENCES posts ON DELETE CASCADE,
    comment_ref BIGINT REFERENCES comments ON DELETE CASCADE,
    comment TEXT NOT NULL,
    date_created TIMESTAMP DEFAULT NOW(),
    date_updated TIMESTAMP DEFAULT NOW()
);

CREATE TABLE tags (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name TEXT NOT NULL
);

CREATE TABLE posts_tags (
    post BIGINT REFERENCES posts ON DELETE CASCADE,
    category BIGINT REFERENCES categories ON DELETE CASCADE
);

/*
CREATE TABLE document_tags (
    post BIGINT REFERENCES posts ON DELETE CASCADE,
    category BIGINT REFERENCES categories ON DELETE CASCADE
);
*/

CREATE TABLE likes_a_comment (
    comment BIGINT REFERENCES comments ON DELETE CASCADE,
    author BIGINT REFERENCES users ON DELETE CASCADE
);

ALTER TABLE IF EXISTS ONLY likes_a_comment
    ADD CONSTRAINT likes_a_comment_pkey PRIMARY KEY (comment, author);

/**
* Likes on a Post
*/
CREATE TABLE likes_a_post (
    post BIGINT REFERENCES posts ON DELETE CASCADE,
    author BIGINT REFERENCES users ON DELETE CASCADE
);

ALTER TABLE IF EXISTS ONLY likes_a_post
    ADD CONSTRAINT likes_a_post_pkey PRIMARY KEY (post, author);

CREATE FUNCTION update_likes_post() RETURNS trigger 
    LANGUAGE plpgsql
    AS $$BEGIN
        UPDATE posts SET likes = likes + 1 WHERE id = NEW.post;
        RETURN NEW;
    END$$;

CREATE TRIGGER update_likes_of_a_post
    AFTER INSERT ON likes_a_post
    FOR EACH ROW
    EXECUTE PROCEDURE update_likes_post();

CREATE FUNCTION delete_likes_post() RETURNS trigger 
    LANGUAGE plpgsql
    AS $$BEGIN
        UPDATE posts SET likes = likes - 1 WHERE id = OLD.post;
        RETURN NEW;
    END$$;

CREATE TRIGGER delete_likes_of_a_post
    AFTER DELETE ON likes_a_post
    FOR EACH ROW
    EXECUTE PROCEDURE delete_likes_post();


INSERT INTO users (email, pass, first_name, last_name, permissions) VALUES ('admin@gmail.com','8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918', 'Admin', 'Admina', 'admin');
INSERT INTO users (email, pass, first_name, last_name, permissions) VALUES ('user1@gmail.com','8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918', 'User', 'Doe', 'user');
INSERT INTO users (email, pass, first_name, last_name, permissions) VALUES ('user2@gmail.com','8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918', 'John', 'User', 'user');

INSERT INTO follows (follower, followed) VALUES (1, 2);

INSERT INTO posts (author, title, content, visibility, date_created) VALUES (2, 'User post', 'This post should NOT be visible', 'private', '2019-12-03');
INSERT INTO posts (author, title, content, visibility, date_created) VALUES (3, 'User post', 'This post should NOT be visible in feed of user 1', 'public', '2019-12-03');
INSERT INTO posts (author, title, content, date_created) VALUES (1, 'Admin post', 'This is a post done by the admin', '2019-12-02');
INSERT INTO posts (author, title, content, visibility, date_created) VALUES (2, 'User post', 'This is a post done by a mere user following the admin', 'followers', '2019-12-01');
INSERT INTO posts (author, title, content) VALUES (1, 'Admin post', 'This is a post done by the admin');
INSERT INTO posts (author, title, content) VALUES (2, 'User post', 'This is a post done by a mere user following the admin');
INSERT INTO posts (author, title, content) VALUES (1, 'Admin post', 'This is a post done by the admin');
INSERT INTO posts (author, title, content) VALUES (2, 'User post', 'This is a post done by a mere user following the admin');
INSERT INTO posts (author, title, content) VALUES (1, 'Admin post', 'This is a post done by the admin');
INSERT INTO posts (author, title, content) VALUES (2, 'User post', 'This is a post done by a mere user following the admin');
INSERT INTO posts (author, title, content) VALUES (1, 'Admin post', 'This is a post done by the admin');
INSERT INTO posts (author, title, content) VALUES (2, 'User post', 'This is a post done by a mere user following the admin');
INSERT INTO posts (author, title, content) VALUES (1, 'Admin post', 'This is a post done by the admin');
INSERT INTO posts (author, title, content) VALUES (2, 'User post', 'This is a post done by a mere user following the admin');
INSERT INTO posts (author, title, content) VALUES (1, 'Admin post', 'This is a post done by the admin');
INSERT INTO posts (author, title, content) VALUES (2, 'User post', 'This is a post done by a mere user following the admin');
INSERT INTO posts (author, title, content) VALUES (1, 'Admin post', 'This is a post done by the admin');
INSERT INTO posts (author, title, content) VALUES (2, 'User post', 'This is a post done by a mere user following the admin');
INSERT INTO posts (author, title, content) VALUES (1, 'Admin post', 'This is a post done by the admin');
INSERT INTO posts (author, title, content) VALUES (2, 'User post', 'This is a post done by a mere user following the admin');
INSERT INTO posts (author, title, content) VALUES (1, 'Admin post', 'This is a post done by the admin');
INSERT INTO posts (author, title, content) VALUES (2, 'User post', 'This is a post done by a mere user following the admin');
INSERT INTO posts (author, title, content) VALUES (1, 'Admin post', 'This is a post done by the admin');
INSERT INTO posts (author, title, content) VALUES (2, 'User post', 'This is a post done by a mere user following the admin');
INSERT INTO posts (author, title, content) VALUES (3, 'User post', 'This is a post done by a mere user');

INSERT INTO comments (author, post, comment) VALUES (1, 1, 'This is a comment done by the admin');
INSERT INTO comments (author, post, comment) VALUES (2, 2, 'This is a comment done by a mere user following the admin');
INSERT INTO comments (author, post, comment) VALUES (1, 3, 'This is a comment done by the admin');
INSERT INTO comments (author, post, comment) VALUES (2, 4, 'This is a comment done by a mere user following the admin');
INSERT INTO comments (author, post, comment) VALUES (1, 5, 'This is a comment done by the admin');
INSERT INTO comments (author, post, comment) VALUES (2, 6, 'This is a comment done by a mere user following the admin');
INSERT INTO comments (author, post, comment) VALUES (1, 7, 'This is a comment done by the admin');
INSERT INTO comments (author, post, comment) VALUES (2, 8, 'This is a comment done by a mere user following the admin');
INSERT INTO comments (author, post, comment) VALUES (1, 9, 'This is a comment done by the admin');
INSERT INTO comments (author, post, comment) VALUES (2, 10, 'This is a comment done by a mere user following the admin');
INSERT INTO comments (author, post, comment) VALUES (2, 1, 'This is a comment done by a mere user following the admin');
INSERT INTO comments (author, post, comment) VALUES (1, 2, 'This is a comment done by the admin');
INSERT INTO comments (author, post, comment) VALUES (2, 3, 'This is a comment done by a mere user following the admin');
INSERT INTO comments (author, post, comment) VALUES (1, 4, 'This is a comment done by the admin');
INSERT INTO comments (author, post, comment) VALUES (2, 5, 'This is a comment done by a mere user following the admin');
INSERT INTO comments (author, post, comment) VALUES (1, 6, 'This is a comment done by the admin');
INSERT INTO comments (author, post, comment) VALUES (2, 7, 'This is a comment done by a mere user following the admin');
INSERT INTO comments (author, post, comment) VALUES (1, 8, 'This is a comment done by the admin');
INSERT INTO comments (author, post, comment) VALUES (2, 9, 'This is a comment done by a mere user following the admin');
INSERT INTO comments (author, post, comment) VALUES (1, 10, 'This is a comment done by the admin');


/* SECOND LEVEL COMMENTS */
INSERT INTO comments (author, post, comment_ref, comment) VALUES (1, 10, 1, 'This is a 2nd level comment done by the admin 1');
INSERT INTO comments (author, post, comment_ref, comment) VALUES (1, 10, 1, 'This is a 2nd level comment done by the admin 2');
INSERT INTO comments (author, post, comment_ref, comment) VALUES (1, 10, 1, 'This is a 2nd level comment done by the admin 3');
INSERT INTO comments (author, post, comment_ref, comment) VALUES (1, 10, 1, 'This is a 2nd level comment done by the admin 4');
INSERT INTO comments (author, post, comment_ref, comment) VALUES (1, 10, 1, 'This is a 2nd level comment done by the admin 5');
INSERT INTO comments (author, post, comment_ref, comment) VALUES (1, 10, 1, 'This is a 2nd level comment done by the admin 6');
INSERT INTO comments (author, post, comment_ref, comment) VALUES (1, 10, 1, 'This is a 2nd level comment done by the admin 7');

INSERT INTO comments (author, post, comment_ref, comment) VALUES (1, 10, 2, 'This is a 2nd level comment done by the admin 1');
INSERT INTO comments (author, post, comment_ref, comment) VALUES (1, 10, 2, 'This is a 2nd level comment done by the admin 2');
INSERT INTO comments (author, post, comment_ref, comment) VALUES (1, 10, 2, 'This is a 2nd level comment done by the admin 3');
INSERT INTO comments (author, post, comment_ref, comment) VALUES (1, 10, 2, 'This is a 2nd level comment done by the admin 4');
INSERT INTO comments (author, post, comment_ref, comment) VALUES (1, 10, 2, 'This is a 2nd level comment done by the admin 5');
INSERT INTO comments (author, post, comment_ref, comment) VALUES (1, 10, 2, 'This is a 2nd level comment done by the admin 6');
INSERT INTO comments (author, post, comment_ref, comment) VALUES (1, 10, 2, 'This is a 2nd level comment done by the admin 7');

/**
* tags related to content
**/
INSERT INTO tags (nome) VALUES ('Question');
INSERT INTO tags (nome) VALUES ('Article');
INSERT INTO tags (nome) VALUES ('Research Paper');
INSERT INTO tags (nome) VALUES ('Conference Paper');
INSERT INTO tags (nome) VALUES ('Presentation');
INSERT INTO tags (nome) VALUES ('Poster');
INSERT INTO tags (nome) VALUES ('Book');
INSERT INTO tags (nome) VALUES ('Project');
INSERT INTO tags (nome) VALUES ('Images');
INSERT INTO tags (nome) VALUES ('Videos');

INSERT INTO tags (nome) VALUES ('New preprint');
INSERT INTO tags (nome) VALUES ('Chapter');

INSERT INTO tags (nome) VALUES ('File Available');
INSERT INTO tags (nome) VALUES ('Full-text available');

/**
* tags related to medical specialities
**/
INSERT INTO tags (nome) VALUES ('Abdominal Radiology');
INSERT INTO tags (nome) VALUES ('Addiction Psychiatry');
INSERT INTO tags (nome) VALUES ('Adolescent Medicine');
INSERT INTO tags (nome) VALUES ('Abdominal Radiology');
INSERT INTO tags (nome) VALUES ('Adult Cardiothoracic Anesthesiology');
INSERT INTO tags (nome) VALUES ('Adult Reconstructive Orthopaedics');
INSERT INTO tags (nome) VALUES ('Advanced Heart Failure & Transplant Cardiology');
INSERT INTO tags (nome) VALUES ('Allergy & Immunology');
INSERT INTO tags (nome) VALUES ('Anesthesiology');

INSERT INTO tags (nome) VALUES ('Biochemical Genetics');
INSERT INTO tags (nome) VALUES ('Blood Banking - Transfusion Medicine');

INSERT INTO tags (nome) VALUES ('Cardiothoracic Radiology');
INSERT INTO tags (nome) VALUES ('Cardiovascular Disease');
INSERT INTO tags (nome) VALUES ('Chemical Pathology');
INSERT INTO tags (nome) VALUES ('Child & Adolescent Psychiatry');
INSERT INTO tags (nome) VALUES ('Child Abuse Pediatrics');
INSERT INTO tags (nome) VALUES ('Child Neurology');
INSERT INTO tags (nome) VALUES ('Clinical & Laboratory Immunology');
INSERT INTO tags (nome) VALUES ('Clinical Cardiac Electrophysiology');
INSERT INTO tags (nome) VALUES ('Clinical Neurophysiology');
INSERT INTO tags (nome) VALUES ('Colon & Rectal Surgery');
INSERT INTO tags (nome) VALUES ('Congenital Cardiac Surgery');
INSERT INTO tags (nome) VALUES ('Craniofacial Surgery');
INSERT INTO tags (nome) VALUES ('Critical Care Medicine');
INSERT INTO tags (nome) VALUES ('Critical Care Medicine');
INSERT INTO tags (nome) VALUES ('Cytopathology');

INSERT INTO tags (nome) VALUES ('Dermatology');
INSERT INTO tags (nome) VALUES ('Dermatopathology');
INSERT INTO tags (nome) VALUES ('Developmental-Behavioral Pediatrics');

INSERT INTO tags (nome) VALUES ('Emergency Medicine');
INSERT INTO tags (nome) VALUES ('Endocrinology, Diabetes & Metabolism');
INSERT INTO tags (nome) VALUES ('Endovascular Surgical Neuroradiology');
INSERT INTO tags (nome) VALUES ('Endovascular Surgical Neuroradiology');
INSERT INTO tags (nome) VALUES ('Endovascular Surgical Neuroradiology');

INSERT INTO tags (nome) VALUES ('Family Medicine');
INSERT INTO tags (nome) VALUES ('Family Practice');
INSERT INTO tags (nome) VALUES ('Female Pelvic Medicine & Reconstructive Surgery');
INSERT INTO tags (nome) VALUES ('Foot & Ankle Orthopaedics');
INSERT INTO tags (nome) VALUES ('Forensic Pathology');
INSERT INTO tags (nome) VALUES ('Forensic Psychiatry');

INSERT INTO tags (nome) VALUES ('Gastroenterology');
INSERT INTO tags (nome) VALUES ('Geriatric Medicine');
INSERT INTO tags (nome) VALUES ('Geriatric Psychiatry');

INSERT INTO tags (nome) VALUES ('Hand Surgery');
INSERT INTO tags (nome) VALUES ('Hematology');
INSERT INTO tags (nome) VALUES ('Hematology & Oncology');

INSERT INTO tags (nome) VALUES ('Infectious Disease');
INSERT INTO tags (nome) VALUES ('Internal Medicine');
INSERT INTO tags (nome) VALUES ('Internal Medicine-Pediatrics');
INSERT INTO tags (nome) VALUES ('Interventional Cardiology');

INSERT INTO tags (nome) VALUES ('Medical Genetics');
INSERT INTO tags (nome) VALUES ('Medical Microbiology'); 
INSERT INTO tags (nome) VALUES ('Medical Toxicology');
INSERT INTO tags (nome) VALUES ('Molecular Genetic Pathology');
INSERT INTO tags (nome) VALUES ('Muscoskeletal Radiology');
INSERT INTO tags (nome) VALUES ('Musculoskeletal Oncology');

INSERT INTO tags (nome) VALUES ('Neonatal-Perinatal Medicine');
INSERT INTO tags (nome) VALUES ('Nephrology');
INSERT INTO tags (nome) VALUES ('Neurological Surgery');
INSERT INTO tags (nome) VALUES ('Neurology');
INSERT INTO tags (nome) VALUES ('Neuromuscular Medicine');
INSERT INTO tags (nome) VALUES ('Neuropathology');
INSERT INTO tags (nome) VALUES ('Neuroradiology');
INSERT INTO tags (nome) VALUES ('Nuclear Medicine');
INSERT INTO tags (nome) VALUES ('Nuclear Radiology');

INSERT INTO tags (nome) VALUES ('Obstetric Anesthesiology');
INSERT INTO tags (nome) VALUES ('Obstetrics & Gynecology');
INSERT INTO tags (nome) VALUES ('Oncology');
INSERT INTO tags (nome) VALUES ('Ophthalmic Plastic & Reconstructive Surgery');
INSERT INTO tags (nome) VALUES ('Ophthalmology');
INSERT INTO tags (nome) VALUES ('Orthopaedic Sports Medicine');
INSERT INTO tags (nome) VALUES ('Orthopaedic Surgery');
INSERT INTO tags (nome) VALUES ('Orthopaedic Surgery of the Spine');
INSERT INTO tags (nome) VALUES ('Orthopaedic Trauma');
INSERT INTO tags (nome) VALUES ('Otolaryngology');
INSERT INTO tags (nome) VALUES ('Otology - Neurotology');

INSERT INTO tags (nome) VALUES ('Pain Medicine');
INSERT INTO tags (nome) VALUES ('Pathology-Anatomic & Clinical');
INSERT INTO tags (nome) VALUES ('Pediatric Anesthesiology');
INSERT INTO tags (nome) VALUES ('Pediatric Cardiology');
INSERT INTO tags (nome) VALUES ('Pediatric Critical Care Medicine');
INSERT INTO tags (nome) VALUES ('Pediatric Emergency Medicine');
INSERT INTO tags (nome) VALUES ('Pediatric Endocrinology');
INSERT INTO tags (nome) VALUES ('Pediatric Gastroenterology');
INSERT INTO tags (nome) VALUES ('Pediatric Hematology-Oncology');
INSERT INTO tags (nome) VALUES ('Pediatric Infectious Diseases');
INSERT INTO tags (nome) VALUES ('Pediatric Nephrology');
INSERT INTO tags (nome) VALUES ('Pediatric Orthopaedics');
INSERT INTO tags (nome) VALUES ('Pediatric Otolaryngology');
INSERT INTO tags (nome) VALUES ('Pediatric Pathology');
INSERT INTO tags (nome) VALUES ('Pediatric Pulmonology');
INSERT INTO tags (nome) VALUES ('Pediatric Radiology');
INSERT INTO tags (nome) VALUES ('Pediatric Rheumatology');
INSERT INTO tags (nome) VALUES ('Pediatric Sports Medicine');
INSERT INTO tags (nome) VALUES ('Pediatric Surgery');
INSERT INTO tags (nome) VALUES ('Pediatric Transplant Hepatology');
INSERT INTO tags (nome) VALUES ('Pediatric Urology');
INSERT INTO tags (nome) VALUES ('Pediatrics');
INSERT INTO tags (nome) VALUES ('Physical Medicine & Rehabilitation');
INSERT INTO tags (nome) VALUES ('Plastic Surgery');
INSERT INTO tags (nome) VALUES ('Preventive Medicine');
INSERT INTO tags (nome) VALUES ('Procedural Dermatology');
INSERT INTO tags (nome) VALUES ('Psychiatry');
INSERT INTO tags (nome) VALUES ('Pulmonary Disease');
INSERT INTO tags (nome) VALUES ('Pulmonary Disease & Critical Care Medicine');

INSERT INTO tags (nome) VALUES ('Radiation Oncology');
INSERT INTO tags (nome) VALUES ('Radiology-Diagnostic');
INSERT INTO tags (nome) VALUES ('Rheumatology');

INSERT INTO tags (nome) VALUES ('Sleep Medicine');
INSERT INTO tags (nome) VALUES ('Spinal Cord Injury Medicine');
INSERT INTO tags (nome) VALUES ('Sports Medicine');
INSERT INTO tags (nome) VALUES ('Surgery-General');
INSERT INTO tags (nome) VALUES ('Surgical Critical Care');

INSERT INTO tags (nome) VALUES ('Thoracic Surgery');
INSERT INTO tags (nome) VALUES ('Thoracic Surgery-Integrated');
INSERT INTO tags (nome) VALUES ('Transplant Hepatology');

INSERT INTO tags (nome) VALUES ('Urology');

INSERT INTO tags (nome) VALUES ('Vascular & Interventional Radiology');
INSERT INTO tags (nome) VALUES ('Vascular Surgery');
